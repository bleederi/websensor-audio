<!--
Websensor audio project
https://github.com/jessenie-intel/websensor-video

Copyright (c) 2017 Jesse Nieminen

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Code based on tutorial from http://www.emanueleferonato.com/2014/12/10/html5-webgl-360-degrees-panorama-viewer-with-three-js/
-->
<!doctype html>
<html>
	<head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=0.6">
                <link rel="manifest" href="manifest.json" />
		<style>
			body{
				margin: 0;
			}
			canvas{
				width: 100%;
				height: 100%
			}
		</style>
		<script src="three.min.js"></script>
		
	</head>
        <template id="sphere-view">
                <style>
                :host {
                width: 100vh;
                height: 100vh;
                }
                canvas {
                margin: 16px;
                }
                </style>
        </template>
	<body>


		<div id="container"></div>

		<script>

			var container;
			var camera, controls, scene, renderer;
			var light, pointLight;

			var material1, material2, material3;

			var analyser1, analyser2, analyser3;

			var clock = new THREE.Clock();

			init();
			animate();

			function init() {

				container = document.getElementById( 'container' );

				camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.set( 0, 25, 0 );

				var listener = new THREE.AudioListener();
				camera.add( listener );

				scene = new THREE.Scene();
				scene.fog = new THREE.FogExp2( 0x000000, 0.0025 );

				light = new THREE.DirectionalLight( 0xffffff );
				light.position.set( 0, 0.5, 1 ).normalize();
				scene.add( light );

				var sphere = new THREE.SphereGeometry( 20, 32, 16 );

				material1 = new THREE.MeshPhongMaterial( { color: 0xffaa00, shading: THREE.FlatShading, shininess: 0 } );
				material2 = new THREE.MeshPhongMaterial( { color: 0xff2200, shading: THREE.FlatShading, shininess: 0 } );
				material3 = new THREE.MeshPhongMaterial( { color: 0x6622aa, shading: THREE.FlatShading, shininess: 0 } );

				// sound spheres

				var audioLoader = new THREE.AudioLoader();

				var mesh1 = new THREE.Mesh( sphere, material1 );
				mesh1.position.set( -250, 30, 0 );
				scene.add( mesh1 );

				var sound1 = new THREE.PositionalAudio( listener );
				audioLoader.load( 'sounds/baby-music-box_daniel-simion.wav', function( buffer ) {
					sound1.setBuffer( buffer );
					sound1.setRefDistance( 20 );
					sound1.play();
				});
				mesh1.add( sound1 );

				//

				var mesh2 = new THREE.Mesh( sphere, material2 );
				mesh2.position.set( 250, 30, 0 );
				scene.add( mesh2 );
/*
				var sound2 = new THREE.PositionalAudio( listener );
				audioLoader.load( 'sounds/376737_Skullbeatz___Bad_Cat_Maste.ogg', function( buffer ) {
					sound2.setBuffer( buffer );
					sound2.setRefDistance( 20 );
					sound2.play();
				});
				mesh2.add( sound2 );
*/
				//


				var mesh3 = new THREE.Mesh( sphere, material3 );
				mesh3.position.set( 0, 30, -250 );
				scene.add( mesh3 );

				var sound3 = new THREE.PositionalAudio( listener );
				var oscillator = listener.context.createOscillator();
				oscillator.type = 'sine';
				oscillator.frequency.value = 144;
				oscillator.start(0);
				sound3.setNodeSource(oscillator);
				sound3.setRefDistance( 20 );
				sound3.setVolume(0.5);
				mesh3.add(sound3);

				// analysers

				analyser1 = new THREE.AudioAnalyser( sound1, 32 );
				//analyser2 = new THREE.AudioAnalyser( sound2, 32 );
				analyser3 = new THREE.AudioAnalyser( sound3, 32 );

				// global ambient audio
/*
				var sound4 = new THREE.Audio( listener );
				audioLoader.load( 'sounds/Project_Utopia.ogg', function( buffer ) {
					sound4.setBuffer( buffer );
					sound4.setLoop(true);
					sound4.setVolume(0.5);
					sound4.play();
				});
*/
				// ground

				var helper = new THREE.GridHelper( 1000, 10, 0x444444, 0x444444 );
				helper.position.y = 0.1;
				scene.add( helper );

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				container.innerHTML = "";
				container.appendChild( renderer.domElement );



				window.addEventListener( 'resize', onWindowResize, false );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );


			}

			function animate() {

				requestAnimationFrame( animate );
				render();

			}


			function render() {

				var delta = clock.getDelta();

				material1.emissive.b = analyser1.getAverageFrequency() / 256;
				//material2.emissive.b = analyser2.getAverageFrequency() / 256;
				material3.emissive.b = analyser3.getAverageFrequency() / 256;

				renderer.render( scene, camera );

			}

		</script>

	</body>
	</body>
</html>

